{% extends "core/base.html" %}
{% load static %}

{% block title %}Panel de administraci칩n{% endblock %}

{% block extra_css %}
<style>
  .admin-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 24px;
    min-height: calc(100vh - 160px);
  }

  @media (max-width: 900px) {
    .admin-layout {
      grid-template-columns: 1fr;
    }
  }

  .admin-sidebar {
    background: #1f2937;
    border-radius: 16px;
    padding: 24px 18px;
    color: #f9fafb;
  }

  .admin-sidebar h2 {
    font-size: 1.3rem;
    margin-bottom: 18px;
  }

  .admin-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .admin-nav li {
    margin-bottom: 8px;
  }

  .admin-nav a {
    display: block;
    padding: 10px 12px;
    border-radius: 10px;
    text-decoration: none;
    color: #e5e7eb;
    font-size: 0.95rem;
  }

  .admin-nav a.active,
  .admin-nav a:hover {
    background: #f97316;
    color: #111827;
  }

  .admin-main {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .admin-header h1 {
    font-size: 1.8rem;
    margin: 0;
  }

  .admin-subtitle {
    color: #6b7280;
    margin: 4px 0 0 0;
    font-size: 0.95rem;
  }

  .chip {
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    background: #ecfdf5;
    color: #166534;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 16px 18px;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
    border: 1px solid #e5e7eb;
  }

  .card h3 {
    margin: 0 0 4px 0;
    font-size: 0.9rem;
    color: #6b7280;
  }

  .card .big-number {
    font-size: 1.6rem;
    font-weight: 600;
    margin: 0;
  }

  .card .muted {
    font-size: 0.8rem;
    color: #9ca3af;
  }

  .card-row {
    display: grid;
    grid-template-columns: 2fr 1.8fr;
    gap: 16px;
  }

  @media (max-width: 1050px) {
    .card-row {
      grid-template-columns: 1fr;
    }
  }

  .section-title {
    font-size: 1.1rem;
    margin-bottom: 8px;
  }

  .section-subtitle {
    font-size: 0.85rem;
    color: #9ca3af;
    margin-bottom: 12px;
  }

  table.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  table.admin-table th,
  table.admin-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }

  table.admin-table th {
    background: #f9fafb;
    font-weight: 500;
    color: #4b5563;
  }

  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
  }

  .badge-gray { background: #e5e7eb; color: #111827; }
  .badge-blue { background: #dbeafe; color: #1d4ed8; }
  .badge-green { background: #dcfce7; color: #166534; }
  .badge-orange { background: #ffedd5; color: #c2410c; }

  .amount {
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<section class="admin-layout">
  <!-- 游댳 Sidebar -->
  <aside class="admin-sidebar">
    <h2>Panel administrador</h2>

    <ul class="admin-nav">
      <li>
        <a href="{% url 'adminpanel:dashboard' %}" 
          class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
          Dashboard
        </a>
      </li>

      <li>
        <a href="{% url 'adminpanel:clientes_list' %}" 
          class="{% if request.resolver_match.url_name == 'clientes_list' %}active{% endif %}">
          Clientes
        </a>
      </li>

      <li>
        <a href="{% url 'adminpanel:pedidos_list' %}" 
          class="{% if request.resolver_match.url_name == 'pedidos_list' %}active{% endif %}">
          Pedidos
        </a>
      </li>

      <li>
        <a href="{% url 'adminpanel:proveedores_list' %}" 
          class="{% if request.resolver_match.url_name == 'proveedores_list' %}active{% endif %}">
          Proveedores
        </a>
      </li>
    </ul>

  </aside>

  <!-- 游댳 Contenido principal -->
  <div class="admin-main">
    <!-- Encabezado -->
    <header class="admin-header">
      <div>
        <h1>Resumen general</h1>
        <p class="admin-subtitle">
          Visualiza el rendimiento de Sabores: pedidos, ingresos y actividad reciente.
        </p>
      </div>
      <span class="chip">
        游녬 Administrador: {{ request.user.username }}
      </span>
    </header>

    <!-- M칠tricas principales -->
    <section class="cards-grid">
      <article class="card">
        <h3>Pedidos totales</h3>
        <p class="big-number">{{ total_pedidos }}</p>
        <p class="muted">Incluye todos los estados</p>
      </article>

      <article class="card">
        <h3>Clientes 칰nicos</h3>
        <p class="big-number">{{ total_clientes }}</p>
        <p class="muted">Usuarios que han realizado al menos un pedido</p>
      </article>

      <article class="card">
        <h3>Proveedores</h3>
        <p class="big-number">{{ total_proveedores }}</p>
        <p class="muted">{{ proveedores_aprobados }} aprobados 췅 {{ proveedores_pendientes }} pendientes</p>
      </article>

      <article class="card">
        <h3>Ingresos totales</h3>
        <p class="big-number">${{ total_ingresos|floatformat:0 }}</p>
        <p class="muted">Solo pedidos confirmados</p>
      </article>

      <article class="card">
        <h3>Ingresos hoy</h3>
        <p class="big-number">${{ ingresos_hoy|floatformat:0 }}</p>
        <p class="muted">Pedidos confirmados en el d칤a</p>
      </article>

      <article class="card">
        <h3>Ingresos este mes</h3>
        <p class="big-number">${{ ingresos_mes|floatformat:0 }}</p>
        <p class="muted">Desde el d칤a 1 del mes actual</p>
      </article>
    </section>

    <!-- Filas con tarjetas: estados + gr치fico + top platos -->
    <section class="card-row">
      <!-- Estados de pedidos -->
      <article class="card">
        <h2 class="section-title">Estado de pedidos</h2>
        <p class="section-subtitle">Distribuci칩n actual por estado</p>

        <div class="cards-grid">
          <div>
            <h3>Pendientes</h3>
            <p class="big-number">{{ pedidos_pendientes }}</p>
          </div>
          <div>
            <h3>Preparando</h3>
            <p class="big-number">{{ pedidos_preparando }}</p>
          </div>
          <div>
            <h3>Entregados</h3>
            <p class="big-number">{{ pedidos_entregados }}</p>
          </div>
        </div>
      </article>

      <!-- Gr치fico ventas 칰ltimos 7 d칤as -->
      <article class="card">
        <h2 class="section-title">Ventas 칰ltimos 7 d칤as</h2>
        <p class="section-subtitle">Monto total por d칤a (pedidos confirmados)</p>
        <canvas id="ventas7dias"></canvas>
      </article>
    </section>

    <!-- Top platos + 칰ltimos pedidos -->
    <section class="card-row">
      <!-- Top platos -->
      <article class="card">
        <h2 class="section-title">Top 5 platos m치s vendidos</h2>
        <p class="section-subtitle">Seg칰n cantidad total pedida</p>

        <table class="admin-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Plato</th>
              <th>Cantidad total</th>
            </tr>
          </thead>
          <tbody>
          {% for p in top_platos %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ p.plato__nombre }}</td>
              <td>{{ p.total_cantidad }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="3">Sin informaci칩n suficiente todav칤a.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </article>

      <!-- 칔ltimos pedidos -->
      <article class="card">
        <h2 class="section-title">칔ltimos pedidos</h2>
        <p class="section-subtitle">Actividad reciente en la plataforma</p>

        <table class="admin-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Plato</th>
              <th>Proveedor</th>
              <th>Estado</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody>
          {% for p in ultimos_pedidos %}
            <tr>
              <td>{{ p.cliente.username }}</td>
              <td>{{ p.plato.nombre }}</td>
              <td>{{ p.plato.proveedor.empresa }}</td>
              <td>
                {% if p.estado == 'pendiente' %}
                  <span class="badge badge-gray">Pendiente</span>
                {% elif p.estado == 'preparando' %}
                  <span class="badge badge-blue">Preparando</span>
                {% elif p.estado == 'entregado' %}
                  <span class="badge badge-green">Entregado</span>
                {% else %}
                  <span class="badge badge-orange">{{ p.estado }}</span>
                {% endif %}
              </td>
              <td>{{ p.fecha_pedido|date:"d/m/Y H:i" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5">No hay pedidos recientes.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </article>
    </section>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labelsDias = {{ labels_dias|safe }};
  const dataDias = {{ data_dias|safe }};

  const ctx = document.getElementById('ventas7dias').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labelsDias,
      datasets: [{
        label: 'Ventas $',
        data: dataDias,
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
</script>
{% endblock %}
